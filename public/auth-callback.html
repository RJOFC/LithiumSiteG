<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Entrando no Lithium...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="./Favicon.png" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #101010;
      --accent: #ff914d;
      --text-main: #f7f7f7;
      --text-muted: #aaaaaa;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top, #202020 0, #101010 55%, #050505 100%);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      text-align: center;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 145, 77, 0.2);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 10px 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .message {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-main);
    }

    .submessage {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .error {
      background: rgba(255, 77, 77, 0.1);
      border: 1px solid rgba(255, 77, 77, 0.3);
      border-radius: 10px;
      padding: 16px;
      margin-top: 20px;
      max-width: 300px;
      display: none;
    }

    .error-title {
      color: #ff7a7a;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .error-text {
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.5;
    }

    .success {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 10px;
      padding: 16px;
      margin-top: 20px;
      max-width: 300px;
      display: none;
    }

    .success-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .success-text {
      color: #4caf50;
      font-weight: 600;
      font-size: 13px;
    }

    .loading-text {
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .retry-btn {
      margin-top: 16px;
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent), #ffb65c);
      color: #1a1209;
      border: none;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .retry-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 77, 77, 0.3);
    }

    .retry-btn:active {
      transform: scale(0.97);
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="./Favicon.png" alt="Lithium logo" class="logo" />
    
    <div id="loading" class="loading-section">
      <div class="spinner"></div>
      <div class="message">Autenticando com Discord...</div>
      <div class="submessage">Um momento enquanto processamos sua autenticação</div>
      <div class="loading-text">Você será redirecionado em breve</div>
    </div>

    <div id="error" class="error">
      <div class="error-title">❌ Erro na Autenticação</div>
      <div class="error-text" id="error-text">
        Não conseguimos autenticar sua conta. Por favor, tente novamente.
      </div>
      <button class="retry-btn" onclick="window.location.href = '/auth/discord'">↻ Tentar Novamente</button>
    </div>

    <div id="success" class="success">
      <div class="success-icon">✓</div>
      <div class="success-text">Login bem-sucedido!</div>
      <div class="loading-text">Redirecionando para página inicial...</div>
    </div>
  </div>

  <script>
    // Verificar se há erro nos parâmetros da URL
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    const code = urlParams.get('code');

    if (error) {
      // Mostrar erro
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      
      const errorMessages = {
        'access_denied': 'Você negou acesso à sua conta Discord. Clique em "Tentar Novamente" para fazer login.',
        'invalid_scope': 'Escopo inválido solicitado.',
        'unsupported_response_type': 'Tipo de resposta não suportado.',
        'invalid_request': 'Requisição inválida. Por favor, tente novamente.'
      };
      
      const errorText = errorMessages[error] || `Erro: ${error}`;
      document.getElementById('error-text').textContent = errorText;
    } else if (code) {
      // Código recebido, aguardando redirecionamento do servidor
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('success').style.display = 'none';
      
      // Aguardar 2 segundos e depois verificar se foi redirecionado
      setTimeout(() => {
        // Se ainda estiver nesta página após 2 segundos, o servidor está processando
        // Isso é esperado, o servidor fará o redirecionamento
      }, 2000);
    } else {
      // Nenhum código e nenhum erro - algo deu errado
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error-text').textContent = 'Erro desconhecido durante a autenticação. Por favor, tente novamente.';
    }

    // Se chegou aqui após o callback com sucesso, mostrar sucesso
    if (code) {
      // Verificar a cada 1 segundo se o usuário foi autenticado
      let checkCount = 0;
      const checkInterval = setInterval(async () => {
        try {
          const resp = await fetch('/api/logged-user', { credentials: 'include' });
          const data = await resp.json();
          
          if (data.user) {
            // Usuário autenticado!
            clearInterval(checkInterval);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';
            
            // Redirecionar para a página inicial após 2 segundos
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        } catch (e) {
          console.error('Erro ao verificar login:', e);
        }
        
        checkCount++;
        // Parar depois de 10 tentativas (10 segundos)
        if (checkCount > 10) {
          clearInterval(checkInterval);
        }
      }, 1000);
    }
  </script>
</body>
</html>
